"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import Header from "@/components/header";
import Footer from "@/components/footer";
import ProcessingStatus from "@/components/processing-status";
import sanitizeHtml from "sanitize-html";
import HtmlPreview from "@/components/HtmlPreview.client";
import Razorpay from "razorpay";
type PricingTier = "free-preview" | "paid"
import Script from "next/script"


export default function PreviewPage() {
  const router = useRouter();
  const [documentHtml, setDocumentHtml] = useState<string | null>(null);
  const [state, setState] = useState<"preview" | "exporting" | "complete" | "error">("preview");
  
  const [tier, setTier] = useState<PricingTier>("free-preview")

  const isPdfAvailable =
  process.env.NODE_ENV === "production"

  useEffect(() => {
    const data = sessionStorage.getItem("documentData");
    if (!data) {
      router.push("/handwritten-to-doc/upload");
      return;
    }
    let structure;
    try {
      structure = JSON.parse(data);
    } catch (e) {
      // fallback if documentData was actually raw HTML string
      setDocumentHtml(data);
      return;
    }
    // if you stored HTML inside structure.html:
    const html = structure.html ?? (structure.sections?.[0]?.content ?? "");
    setDocumentHtml(html);
    if (!html) {
      router.push("/handwritten-to-doc/upload");
      return;
    }
    // Sanitize HTML before injecting into the DOM
    const clean = sanitizeHtml(html, {
      allowedTags: [
        ...sanitizeHtml.defaults.allowedTags,
        "h1", "h2", "h3",
        "table", "thead", "tbody", "tr", "th", "td",
        "style", "colgroup", "col"
      ],
      allowedAttributes: {
        "*": ["style", "class"],
      },
      allowedSchemes: ["data", "http", "https"],
    });
    setDocumentHtml(clean);
  }, [router]);

  useEffect(() => {
    const params = new URLSearchParams(window.location.search)
    if (params.get("paid") === "1") {
      setTier("paid")
    }
  }, [])

  const handleDownload = async (type: "docx" | "pdf") => {
    if (!documentHtml) return;
    setState("exporting");

    const endpoint =
      type === "pdf"
        ? "/api/handwritten/export/pdf"
        : "/api/handwritten/export";

    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          html: documentHtml,
          title: "Converted_Document",
        }),
      });

      if (!res.ok) throw new Error("Export failed");

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download =
        type === "pdf"
          ? "Converted_Document.pdf"
          : "Converted_Document.docx";

      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      setState("complete");
    } catch (err) {
      console.error("Export error:", err);
      setState("error");
    }
  };
  
  const handlePaidDownload = async (type: "docx" | "pdf") => {
    // üß± Block free users
    if (tier !== "paid") {
      try {
        const res = await fetch("/api/checkout/create-session", {
          method: "POST",
        })

        if (!res.ok) {
          const text = await res.text().catch(() => "")
          console.error("‚ùå Payment session failed:", text)
          alert("Unable to start payment. Please try again.")
          return
        }

        const data = await res.json()

        /* ================= PAYPAL ================= */
        if (data.gateway === "paypal") {
          if (!data.approveUrl) {
            console.error("‚ùå Missing PayPal approve URL", data)
            alert("Payment setup failed. Please try again.")
            return
          }

          window.location.href = data.approveUrl
          return
        }

        /* ================= RAZORPAY ================= */
        if (data.gateway === "razorpay") {
          if (!window.Razorpay) {
            alert("Razorpay SDK not loaded")
            return
          }

          // @ts-ignore
          const rzp = new window.Razorpay({
            key: data.key,
            amount: data.order.amount,
            currency: "INR",
            order_id: data.order.id,
            name: "Handwritten ‚Üí DOC",
            description: "One-time document conversion",
            handler: () => {
              // ‚úÖ Payment success ‚Üí unlock downloads
              window.location.href =
                "/handwritten-to-doc/preview?paid=1"
            },
            modal: {
              ondismiss: () => {
                console.log("Payment cancelled by user")
              },
            },
          })

          rzp.open()
          return
        }

        console.error("‚ùå Unknown payment gateway:", data)
        alert("Unsupported payment method")
        return
      } catch (err) {
        console.error("üî• Payment init error:", err)
        alert("Payment failed. Please retry.")
        return
      }
    }

    /* ================= PAID USER ================= */
    handleDownload(type)
  }




  if (!documentHtml) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <p className="text-muted-foreground">Loading preview‚Ä¶</p>
      </div>
    );
  }

  return (

    <>
    <Script
        src="https://checkout.razorpay.com/v1/checkout.js"
        strategy="afterInteractive"
      />
    <div className="min-h-screen flex flex-col">
      <Header />
      <main className="flex-1 bg-muted/30">
        <section className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12">
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">

            {/* LEFT: Document Preview */}
            <div className="lg:col-span-8">
              <div className="rounded-xl border bg-white shadow-sm">
                <HtmlPreview
                    htmlFragment={documentHtml}
                    height="82vh"
                    showWatermark={tier === "free-preview"}
                  />
              </div>
            </div>

            {/* RIGHT: Actions */}
            <div className="lg:col-span-4">
              <div className="sticky top-24 space-y-6">

                <div className="rounded-xl border bg-white p-6 shadow-sm">
                  <h3 className="text-base font-semibold text-slate-900 mb-1">
                    Document Actions
                  </h3>
                  <p className="text-xs text-muted-foreground mb-4">
                    This document is read-only in preview
                  </p>

                  {/* <button
                    disabled={tier === "free-preview"}
                    onClick={() => handleDownload("docx")}
                    className={`btn btn-primary w-full ${
                      tier === "free-preview" ? "opacity-50 cursor-not-allowed" : ""
                    }`}
                  >
                    Download DOCX
                  </button>

                  <button
                    disabled={tier === "free-preview"}
                    onClick={() => handleDownload("pdf")}
                    className={`btn w-full mt-2 ${
                      tier === "free-preview" ? "opacity-50 cursor-not-allowed" : ""
                    }`}
                  >
                    Download DOCX
                  </button> */}

                  <div className="mb-4 rounded-lg border border-green-200 bg-green-50 p-3">
                    <div className="flex items-center gap-2 text-sm font-medium text-green-700">
                      <span>‚óè</span> Processing Complete
                    </div>
                    <p className="text-xs text-green-600 mt-1">
                      Document is ready for export
                    </p>
                  </div>
                  <button
                    onClick={() => handlePaidDownload("docx")}
                    className="btn btn-primary w-full"
                  >
                    Upgrade to Download (DOCX)
                  </button>

                  {isPdfAvailable && (
                    <button
                      onClick={() => handlePaidDownload("pdf")}
                      className="btn w-full mt-2"
                    >
                      Upgrade to Download (PDF)
                    </button>
                  )}
                  {/* <button
                    onClick={() => handleDownload("pdf")}
                    className="btn w-full mt-2"
                  >
                    Download PDF
                  </button> */}

                  <div className="rounded-xl border bg-white p-4 shadow-sm">
                    <h4 className="text-sm font-medium mb-3">Document Info</h4>
                    <ul className="space-y-1 text-xs text-muted-foreground">
                      <li>Pages: 1</li>
                      <li>Words: {documentHtml.split(/\s+/).length}</li>
                      <li>Processing time: ~2‚Äì4s</li>
                    </ul>
                  </div>

                  {tier === "free-preview" && (
                    <div className="mt-4 rounded-md border border-dashed border-border p-3 text-xs text-muted-foreground">
                      Preview mode enabled.  
                      Downloads are disabled until payment.  
                      Strict accuracy mode is applied automatically.
                    </div>
                  )}

                  {/* üëá ADD THIS BLOCK */}
                  <p className="mt-4 text-xs text-muted-foreground leading-relaxed">
                    Final document is fully editable in Microsoft Word or Google Docs.
                  </p>
                </div>


                <div className="rounded-xl border bg-white p-6 shadow-sm">
                  <button
                    onClick={() => router.push("/handwritten-to-doc/upload")}
                    className="w-full rounded-md border border-neutral-300 px-4 py-2.5 text-sm hover:bg-neutral-50"
                  >
                    Process Another Document
                  </button>
                </div>

                {state === "exporting" && <ProcessingStatus state="exporting" />}
                {state === "complete" && (
                  <p className="text-sm text-green-600">Download complete</p>
                )}
              </div>
            </div>


          </div>
        </section>
      </main>
      <Footer />
    </div>

  </>  
  );
}
