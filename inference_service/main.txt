from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
import requests
import base64
import os


SYSTEM_PROMPT_STRICT = """
You are a strict document transcription system for official documents.

PRIMARY RULE:
- Preserve structure EXACTLY as seen in the document.

DO NOT:
- Merge rows
- Merge table cells
- Combine fields
- Reorder content
- Reword text
- Infer missing information

FORMS & TABLES:
- If content appears tabular → output an HTML <table>
- Each handwritten row → one <tr>
- Each column → one <td>
- Empty or unclear cells → write [illegible] or leave blank
- Keep original row order

FIELDS:
- Preserve field labels exactly
- Keep each field on its own line
- If value missing → leave empty or write [illegible]

OUTPUT RULES:
- Output ONLY valid HTML
- Include embedded CSS inside <style>
- NO markdown
- NO explanations
"""

SYSTEM_PROMPT_NORMAL = """
You are a professional document formatter.

Your task:
- Read handwritten text
- Clean and lightly normalize formatting
- Improve readability while preserving meaning

STRICT OUTPUT RULES:
- Output ONLY valid HTML
- Include embedded CSS inside <style>
- NO markdown
- NO explanations
"""


app = FastAPI(title="Ink2Doc Inference")

OPENROUTER_API_KEY = os.environ["OPENROUTER_API_KEY"]

class InferenceRequest(BaseModel):
    image_base64: str
    strict: bool = True

@app.post("/process")
def process(req: InferenceRequest):
    prompt = SYSTEM_PROMPT_STRICT if req.strict else SYSTEM_PROMPT_NORMAL

    payload = {
        "model": "google/gemini-2.5-flash-image-preview",
        "max_tokens": 1500,
        "temperature": 0.0 if req.strict else 0.2,
        "messages": [
            {
                "role": "system",
                "content": prompt
            },
            {
                "role": "user",
                "content": [
                    {
                        "type": "text",
                        "text": (
                            "Transcribe this document exactly. Preserve structure."
                            if req.strict
                            else
                            "Convert this handwritten document into a clean professional document."
                        )
                    },
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": f"data:{req.mime};base64,{req.image_base64}"
                        }
                    }
                ]
            }
        ]
    }

    res = requests.post(
        "https://openrouter.ai/api/v1/chat/completions",
        headers={
            "Authorization": f"Bearer {OPENROUTER_API_KEY}",
            "Content-Type": "application/json"
        },
        json=payload,
        timeout=60
    )

    if not res.ok:
        raise HTTPException(status_code=500, detail=res.text)

    result = res.json()
    content = result["choices"][0]["message"]["content"]

    html = "".join(
        block.get("text", "") for block in content
    ) if isinstance(content, list) else content

    return {"html": html}
